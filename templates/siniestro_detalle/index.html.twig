{% extends 'base.html.twig' %}

{% block title %}Detalles de Siniestros{% endblock %}

{% block body %}
<style>
/* SiniestroDetalle - compact list styling */
.sdh-header { display:flex; align-items:center; gap:.75rem; padding:1rem 1.25rem; border-radius:.5rem; color:#fff; margin-bottom:1.25rem; background: linear-gradient(135deg,#ef4444 0%, #f97316 100%); }
.sdh-card { max-width:1100px; margin:0 auto; }
.sdh-table { background:#fff; border-radius:.5rem; box-shadow: 0 8px 30px rgba(36,37,38,0.06); overflow:hidden; }
.sdh-table table { margin:0; }
@media (max-width:600px){ .sdh-header h1{ font-size:1.05rem } }
</style>

<div class="container mt-4">
    <div class="sdh-header">
        <i class="bi bi-list-ul me-2" aria-hidden="true"></i>
        <h1 class="mb-0">Detalles de Siniestros</h1>
    </div>

    <div class="sdh-card">
        <div class="sdh-table">
            <table class="table table-striped mb-0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Siniestro</th>
                        <th>Persona</th>
                        <th>Rol</th>
                        <th>Patente</th>
                        <th>Observaciones</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                {% for detalle in detalles %}
                    <tr>
                        <td>{{ detalle.id }}</td>
                        <td>{{ detalle.siniestro.id }}</td>
                        <td>{{ detalle.persona ? detalle.persona.nombre : '—' }}</td>
                        <td>{{ detalle.rol ? detalle.rol.descripcion : '—' }}</td>
                        <td>{{ detalle.vehiculoPatente }}</td>
                        <td>{{ detalle.observaciones }}</td>
                        <td class="d-flex gap-2">
                            {% if is_granted('ROLE_ADMIN') %}
                                <a href="{{ path('siniestro_detalle_edit', {'id': detalle.id}) }}" class="btn btn-warning btn-sm">Editar</a>
                                <button type="button"
                                        class="btn btn-danger btn-sm js-delete-btn"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteModal"
                                        data-url="{{ path('siniestro_detalle_delete', {'id': detalle.id}) }}"
                                        data-token="{{ csrf_token('delete' ~ detalle.id) }}"
                                        data-label="{{ detalle.persona ? detalle.persona.nombre : 'ID ' ~ detalle.id }}">
                                    Eliminar
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="7">No se encontraron detalles.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Delete confirmation modal (reusable) -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteModalLabel"><i class="bi bi-trash-fill me-2"></i>Confirmar eliminación</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <p id="deleteModalBody">¿Seguro que desea eliminar este detalle? Esta acción no se puede deshacer.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <form id="deleteModalForm" method="post" action="">
                            <input type="hidden" name="_token" value="">
                            <button type="submit" class="btn btn-danger">Eliminar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script>
        document.addEventListener('DOMContentLoaded', function(){
            var modalBody = document.getElementById('deleteModalBody');
            var deleteForm = document.getElementById('deleteModalForm');
            var tokenInput = deleteForm.querySelector('input[name="_token"]');

            document.querySelectorAll('.js-delete-btn').forEach(function(btn){
                btn.addEventListener('click', function(){
                    var url = btn.getAttribute('data-url');
                    var token = btn.getAttribute('data-token');
                    var label = btn.getAttribute('data-label') || '';
                    modalBody.textContent = '¿Seguro que desea eliminar el detalle: ' + label + '? Esta acción no se puede deshacer.';
                    deleteForm.action = url;
                    tokenInput.value = token;
                });
            });
        });
        </script>
    </div>
</div>
{% endblock %}
